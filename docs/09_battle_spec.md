# 09 バトルモード仕様

> **親仕様**: [01_app_spec.md](01_app_spec.md)
> **関連仕様**: [06_screen_specs.md](06_screen_specs.md)

---

## 0. 概要

学習のモチベーションを高めるための「対戦/協力」機能。
リアルタイムではなく、ローカルでの「オフライン対戦（1台の端末を2人で操作）」を提供する。

### 0.1 コンセプト
- **楽しさ重視**: 学習効率よりも「盛り上がり」を優先する。
- **シンプル**: 複雑なルールを排除し、直感的に遊べるようにする。
- **協力**: 勝ち負けだけでなく、二人で力を合わせるモードを用意する。

---

## 1. ゲームモード

### 1.1 ボス協力バトル (Boss Coop)
二人で協力して、制限時間内にボスのHPを削りきるモード。

| 項目 | 設定値 | 備考 |
|---|---|---|
| **勝利条件** | ボスのHPを0にする | |
| **敗北条件** | 制限時間が0になる | |
| **制限時間** | 90秒 | 固定 |
| **ボスHP** | 100 | 固定 |
| **基礎ダメージ** | 10 | 1問正解ごとのダメージ |
| **コンボボーナス** | 15 | 3コンボ以上でダメージアップ |
| **ペナルティ** | 2秒ロック | 不正解時、そのプレイヤーの操作不能 |

**コンボ仕様**
- 両プレイヤーの正解が連続するとコンボカウントが増加。
- どちらかが不正解になるとコンボはリセットされる（0に戻る）。
- 3コンボ以上で「コンボアタック」となり、ダメージが **1.5倍（15）** になる。

### 1.2 つなひきバトル (Tug of War)
二人で対戦し、正解数で綱を引き合うモード。

| 項目 | 設定値 | 備考 |
|---|---|---|
| **勝利条件** | 綱を自分の陣地（端）まで引く | 先に5ポイント差をつける |
| **最大ステップ** | 5 | 中央0から±5で決着 |
| **正解効果** | 相手側に1歩押し込む | 自分のカウント+1、相手のカウント-1 |
| **不正解効果** | なし（ロックのみ） | 2秒ロック（オプション） |

※ 実装簡略化のため、現在は「ボス協力バトル」をメインに据えている。

---

## 2. プレイヤー設定

対戦前に、各プレイヤー（1P/2P）ごとに以下の設定を行う。

### 2.1 学年・レベル (Grade)
学年に応じて出題レベルを自動調整する（ハンデキャップ機能）。

| Grade | 学年 | 算数レベル範囲 | 英語レベル範囲 |
|---|---|---|---|
| **1** | 小学1年 | Lv.1 - Lv.20 (繰上がりなし〜単純計算) | Lv.1 - Lv.2 |
| **2** | 小学2年 | Lv.1 - Lv.40 (筆算・九九) | Lv.1 - Lv.3 |
| **3** | 小学3年 | Lv.41 - Lv.60 (3桁・割り算) | Lv.2 - Lv.4 |
| **4** | 小学4年 | Lv.61 - Lv.80 (小数・概数) | Lv.3 - Lv.5 |
| **5** | 小学5年 | Lv.81 - Lv.100 (分数・少数乗除) | Lv.4 - Lv.6 |
| **6** | 小学6年 | Lv.101+ (複雑な計算・単位) | Lv.5 - Lv.8 |

※ 具体的なSkillID範囲は `src/domain/battle/gradeMapping.ts` を参照。

### 2.2 科目 (Subject)
プレイヤーごとに科目を選択可能（異種格闘技戦も可能）。

- **算数 (Math)**: 計算問題（数字入力）
- **英語 (Vocab)**: 英単語（4択選択）

※ ボス協力バトルの場合、役割分担（1Pは算数、2Pは英語など）が可能。

---

## 3. 画面フロー

### 3.1 セットアップ画面
- 1P / 2P の設定を行う（名前、学年、科目）。
- 「スタート」ボタンでカウントアップ開始。

### 3.2 バトル画面
- 画面を上下（スマホ縦持ち）または左右（タブレット横持ち想定）に分割。
- 中央に「ボスHPバー」または「綱引きゲージ」を表示。
- 各プレイヤー領域に問題と入力UIを表示。

**UI構成**
- **ヘッダー**: タイマー、ボスHPゲージ（共通）
- **1Pエリア**: 問題文、回答キーパッド/ボタン、コンボ表示
- **2Pエリア**: 問題文、回答キーパッド/ボタン、コンボ表示

### 3.3 リザルト画面
- **WIN / LOSE** の表示。
- **スコア**: 各プレイヤーの正解数、最大コンボ数。
- **再戦ボタン**: そのままの設定でもう一度。
- **ホームへ**: バトル終了。

---

## 4. 技術仕様メモ

- **InputType**: 対戦用に簡略化した入力を使用。
    - 算数: テンキー（答えのみ入力、筆算UI等はなし）
    - 英語: 4択ボタン
- **問題生成**: `src/domain/battle/engine.ts` で都度生成。永続化はしない。
- **状態管理**: `useReducer` によるローカルステート管理（サーバー同期なし）。
