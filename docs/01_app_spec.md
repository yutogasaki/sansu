# 01 アプリ仕様書

## 目次

- [0. 仕様書体系（親＝神様）](#0-仕様書体系親神様)
- [1. 機能一覧（アプリができること）](#1-機能一覧アプリができること)
- [2. コンセプト（設計思想）と体験フロー](#2-コンセプト設計思想と体験フロー)
- [3. UI・画面構成](#3-ui画面構成)
- [4. 操作仕様（入力・スキップ・PC操作）](#4-操作仕様入力スキップpc操作)
- [5. 学習ロジック](#5-学習ロジック)
- [6. テスト機能（アプリ内・PDF）](#6-テスト機能アプリ内pdf)
- [7章] データ構造（ローカル保存）](#7-データ構造ローカル任意同期)
- [8. 技術仕様](#8-技術仕様)
- [補遺](#補遺a仕様書間の整合ルール)

---

## 0. 仕様書体系（親＝神様）

### 0.0 この仕様書の読み方（簡易目次）

- **0章**：仕様書の役割と参照関係（01が神様／02・03など子は従属）
- **1章**：機能の全体像（学習・モチベ・テストPDF・同期など）
- **2章**：コンセプトと体験フロー（判断を減らす／即開始）
- **3章**：UI・画面構成（縦スクロール禁止、ナビ方針）
- **4章**：操作仕様（入力パッド、複数マス、PCキー操作）
- **5章**：学習ロジック（解放/昇格、復習、ミックス配分、苦手、忘却曲線）
- **6章**：テスト作成（PDF出力）
- **7章**：データ構造（ローカル＋任意同期）
- **8章**：技術仕様
- **補遺**：仕様書間の整合ルール／定数・閾値一覧

（迷ったら）
- “数字・閾値・アルゴリズム”は **01本体**を正とし、子仕様書は参照のみ

### 0.1 仕様書一覧と役割（依存関係）

| No. | ファイル名 | 役割 | 依存 | 主に決めること |
|---:|---|---|---|---|
| 01 | アプリ仕様書（本書） | **全体設計（親／神様）** | ― | 画面原則、学習ロジック、忘却曲線、データ構造、定数・閾値 |
| 02 | 02_math_skills.md | 算数仕様書（子） | 01 | スキル一覧（レベル順）、UI詳細仕様 |
| 03 | 03_english_skills.md | 英語仕様書（子） | 01 | メタ情報、選択肢生成ルール |
| 04 | 04_math_problems.md | 算数問題集（孫） | 02 | 詳細な問題生成ルール（データ） |
| 05 | 05_english_words.md | 英単語帳（孫） | 03 | 単語リスト（レベル順） |
| 06 | 06_screen_specs.md | 画面・テスト仕様（子） | 01 | 画面構成、IA、テスト詳細 |
| 07 | 07_ui_design_guideline.md | UIデザインガイド（子） | 01, 06 | デザイン思想、カラー、タイポグラフィ、演出ルール |

### 0.2 親子仕様の境界（インターフェース契約）

**01 が定義（Single Source of Truth）**
- 解放条件（窓サイズ/閾値）、メイン昇格条件、復習上限、期限超過スコア、クールダウン、苦手判定、ミックス配分（ポイント重み）
- 入力パッド/フォーカス/キー操作などの操作仕様
- データモデル（UserProfile / MemoryState / Backup など）

**02/03/04/05/06/07 が定義（コンテンツ・UI・デザイン）**
- ID体系（skillId/wordId）とレベル所属
- 各項目のメタ情報（例：inputType、桁数・範囲、jpMeaningなど）
- 問題生成テンプレ・単語リスト
- **06**: 画面IA、ホーム・きろく・テストの詳細挙動
- **07**: UIデザイン、カラー、タイポグラフィ、演出のガイドライン

### 0.3 変更・整合の運用方針（読み方）

- **01が神様**：数値・閾値・アルゴリズムは原則01に集約
- **02以降はコンテンツ**：ID、所属レベル、メタ情報、生成テンプレに限定
- 不整合が起きやすい箇所と再発防止ルールは **補遺**に集約

---

## 1. 機能一覧（アプリができること）

### 1.1 対象範囲

| 科目 | 対象 | 内容 |
|------|------|------|
| 算数 | 小学1〜6年 | 四則演算、分数、小数（図形・文章題なし） |
| 英単語 | 中学1〜3年 | 基本単語（英語→日本語の4択） |

### 1.2 学習（メイン機能）

- 起動後、ホームの「はじめる」ボタンで学習開始（詳細は06参照）
- 算数＋英単語は **ミックス出題**が基本（設定で算数のみ／英語のみも可能）
- 忘却曲線により「復習」を自動で優先
- 解放（最大解放）とメイン昇格（中心）を分離し、進み方を安定させる

### 1.3 入力（回答方式）

- 英単語：4択ボタン
- 算数：数字入力（テンキー）
- 算数（複数入力）：マス入力＋専用パッド（フォーカスが明確）
- 算数（choice）：大小比較などの選択式（英単語と同型）

### 1.4 ユーザー切り替え（プロフィール）

- 端末内に複数プロフィールを保持（家族利用）
- 通常起動は「最後に使ったプロフィール」で即開始

### 1.5 モチベーション（義務感を作らない）

- 連続学習（軽い称賛のみ）
- 今日の目標（未達ペナルティなし）
- サウンド（任意）

### 1.6 テスト機能（ちからチェック・PDF）

- **ちからチェック**: 定着確認・イベント（詳細は06参照）
- **PDF作成**: 紙テスト生成（科目単独）

---

## 2. コンセプト（設計思想）と体験フロー

### 2.1 目指す体験

**考えずに始まり、自然に続き、いつでもやめられる学習**

- **即開始：** ホームからワンタップで開始
- **タップだけ：** 基本操作は選択肢か数字をタップするだけ
- **スキップ：：** わからない問題はスキップできる
- **段階的解放：** できるようになったら次が解放される
- **手動調整可：** 設定から解放・ON/OFF切替できる

### 2.2 設計原則

| 原則 | 説明 |
|------|------|
| 判断を減らす | ユーザーに考えさせない。自動で最適な問題を出す |
| 失敗をなくす | スキップしても、間違えても、やめても失敗にならない |
| 摩擦を減らす | 起動から学習開始までワンタップ（ホーム経由） |
| 達成を押し付けない | ノルマや義務感を生まない |
| 積み上げより再開 | データ消失は失敗ではない。いつでもやり直せる |

### 2.3 やらないこと（禁止事項）

| 禁止事項 | 理由 |
|----------|------|
| ランキング・比較 | 競争はモチベーションを下げる |
| ノルマ・義務化 | 「やらなきゃ」は続かない |
| 未達成ペナルティ | 失敗体験を作らない |
| 複雑な操作 | タップとスワイプ以外は不要 |
| 過度な演出 | シンプルさを損なわない |
| 図形・文章題 | 計算力に特化する |
| 評価的な統計表示 | 義務感を生む指標は表示しない |

### 2.4 体験フロー

**初回起動（06_screen_specs.md 参照）**
```
起動 → 初回設定フロー（名前・学年・科目・到達目安） → ホーム → 学習開始
```

**初回起動時の初期化ロジック**
1. **学年基準**: 指定された学年に基づき、内部的な基準レベルを決定。
2. **到達目安補正**: 「どこまでやった？」の回答に基づき、基準レベルを補正（±5レベル）。
3. **スタートレベル決定**:
   - `mathStartLevel`: 補正後のレベルを上限・下限クリップして設定。
   - `vocabStartLevel`: 学年＋自己申告から簡易推定。
4. **解放状態の適用**:
   - 決定した `mathStartLevel` 以下のレベルはすべて **「解放済み(unlocked=true)」かつ「完了(retired/maintenance)」扱い** とする（詳細は 5.6 参照）。
   - `maxUnlockedLevelMath` = `mathStartLevel` + 1（次の挑戦レベル）
   - `subjectMode`: ユーザー選択に従う（デフォルト "mix"）。

**通常起動**
```
起動 → ホーム → 学習開始
```

> 初回フローは「テスト」ではなく「設定」の体験とする。
> ユーザーに点数やレベル数値は見せず、自然に適切な難易度からスタートさせる。


**通常起動**
```
起動 → ホーム → 学習画面（ミックス出題）
```

**学習中**
```
問題 → 回答 → 正誤フィードバック → 次の問題
    → スキップ → 答え表示 → 次の問題
```

**終了**
- いつでも終了可能（確認なし）
- 進捗は自動保存

---

## 3. UI・画面構成

※ 詳細な画面構成、IA（タブ設計）、各画面の挙動は **[06_screen_specs.md](06_screen_specs.md)** を参照のこと。

### 3.1 UI原則（01定義）

- **学習画面は縦スクロール禁止（1画面完結）**
  - モバイル端末でも全要素が収まるよう、動的リサイズやフレックス配置を行う。
- **下部タブ3構成**（ホーム / きろく / せってい）
- 学習開始導線はホームに一本化

詳細な画面仕様は **06** を正とする。

---

## 4. 操作仕様（入力・スキップ・PC操作）

### 4.1 プロフィール切り替え

- 端末内に複数プロフィールを保持
- 通常起動は最後に使用したプロフィールで即学習開始
- 切替は **≡ → 設定 → プロフィール管理**

**切替時の挙動（確定）**
- 切替操作を行った瞬間に **現在の問題は破棄**し、即座に新プロフィールの学習対象へ切り替える
- 履歴・記憶状態・統計はプロフィールごとに保持

### 4.2 基本操作

| 操作 | アクション | 結果 |
|------|------------|------|
| タップ | 選択肢 or 数字 | 回答・正誤判定 |
| 左スワイプ | 問題カード | スキップ・答え表示（主にスマホ） |
| ボタン | Skip | スキップ・答え表示（PC代替） |
| キー | `S` / `Esc` | スキップ・答え表示（PC代替） |
| キー | `0-9` | 数字入力（算数） |
| キー | `Backspace` | 1文字けす（←） |
| キー | `Delete` | クリア（C） |
| キー | `Enter` | 決定（OK） |
| キー | `←` / `→` | フォーカス移動（複数入力時） |
| キー | `1-4` | 4択の選択（英単語） |

### 4.3 回答方式（UI切替）

| 問題タイプ | 方式 | UI |
|------|------|-----|
| 英単語 | 4択タップ | 大きなボタン4つ |
| 算数（単一入力） | 数字入力 | 0-9テンキー + 決定 |
| 算数（複数入力） | 数字入力 | マス + 専用パッド + 決定 |
| 算数（choice） | ボタン選択 | 例：`＜ ＝ ＞` |

（推奨）問題カード内に **科目バッジ（算/英）** を表示。

### 4.4 英単語（4択）の操作ルール（最小）

- タップまたはキー `1-4` で回答

### 4.5.1 問題の定義（Problem）

* **1問（Problem）**: 1回の解答入力（または一連の入力完了）で完結する最小単位。
* 計算の途中経過や、位ごとの分割入力は、それ全体で「1問」とみなす。
* 問題データ（種、正解、オペランド）は都度生成され、永続保存はしない。

### 4.6 算数：複数入力（あまり・分数・帯分数）の入力仕様（専用パッド）

### 4.6 算数：複数入力（あまり・分数・帯分数）の入力仕様（専用パッド）

算数は原則「数字入力（0-9テンキー + 決定）」だが、**入力欄が2つ以上**になる回答形式では、
迷わない入力のため **回答形式に合わせた専用パッド**と **マス（1桁セル）**を用いる。

**用語**
- マス：数字1桁分の入力セル（[□]）
- フィールド：マスのまとまり（商/余り、分子/分母 など）
- フォーカス：現在入力対象のマス（視覚的に明確）
- 専用パッド：0-9、←、C、OK、フィールド切替 など

**共通ルール（必須）**
1. フォーカスは常に視覚的に分かる（太枠／淡い背景／カーソル点滅 等）
2. 数字入力で **次のマスへ自動遷移**する
3. 自動遷移に加え、専用パッドに **手動切替ボタン（←/→）**を併設する
4. マス数は **問題が決まった時点で自動決定**する（原則：正解の桁数から算出）
5. 削除（←）は直感的であること

**A) マス数の自動決定（推奨：正解の桁数から算出）**
- あまりあり割り算（商＋余り）
  - 商：Q = 桁数(商)
  - 余り：R = max(1, 桁数(余り))（余り=0でも1マス）
  - 例：150 ÷ 4 = [□][□] あまり [□]
- 分数（分子＋分母）
  - 分子：N = max(1, 桁数(分子))
  - 分母：D = max(1, 桁数(分母))
- 帯分数（整数＋分子＋分母）
  - 整数：W = max(1, 桁数(整数))
  - 分子：N = max(1, 桁数(分子))
  - 分母：D = max(1, 桁数(分母))

**B) フォーカスと自動遷移**
- 初期フォーカス：先頭フィールドの先頭マス
- フィールド内最終マスまで埋まったら次フィールドへ自動移動
- 最終フィールド最終マスまで埋まったらOK待ち

**C) 手動切替（専用パッド必須）**
- 直ジャンプ切替を用意（例：商へ/余りへ、分子へ/分母へ…）
- 各フィールドをタップしてフォーカス移動できる（推奨）

**D) 削除（← / C）**
- ←：現在マスが埋まっていれば空にする。空なら1つ前へ戻って空にする
- C：全マスを空にし、フォーカスを先頭へ戻す

**E) OK（決定）**
- 未入力マスがある場合：不足マスを強調して進めない
- 全マスが埋まっている場合：組み立てて判定

**F) 出題上限（推奨）**
- 商：最大3桁／余り：最大2桁
- 分子/分母：最大3桁（レベル別に調整）

### 4.7 スキップの扱い

### 4.7 スキップの扱い

* UI: 問題カードを左スワイプ、またはPCならスキップボタン/キー。
* **制限**: **1問につき1回だけ** 可能（答えを見て次へ進む）。
* **評価**: **不正解（Incorrect）** として扱う。
* **学習への影響**:
  * `strength = 1`（リセット）
  * `nextReview = 今日`（直近で再出題されやすくする）
* **ガード**: 同一項目のスキップが **連続3回** 起きた場合は、当日は出題停止（翌日に回す）。

---

## 5. 学習ロジック

### 5.0 基本方針（ロジックの分離）

* **科目ごとの最適化**: 算数（運動スキル的）と英語（暗記的）は学習性質が異なるため、**内部ロジックを分離**して管理する。
* **共通体験**: ユーザーから見た「UI・体験・フロー」は統一する。
* **用語の統一**: 「復習」「要復習」などの用語は共通化するが、その挙動（強い強制力か、優先度調整か）は科目ごとに定義する。

### 5.1 用語・概念定義

UIに露出しない内部用語でも、仕様上の基準として定義する。

**用語定義一覧（共通）**

| 用語 | 対象 | 意味 | UI表示 |
|---|---|---|---|
| **wordId** | 英語 | 英単語1語を表す識別子 | 非表示 |
| **skillId** | 算数 | 算数スキル1種を表す識別子 | 非表示 |
| **strength** | 共通 | 記憶・習熟の安定度（1〜5） | 非表示 |
| **nextReview** | 共通 | 次に優先出題される日付 | 非表示 |
| **要復習（Due）** | 共通 | `nextReview <= 今日` の状態 | UIでは「復習」 |
| **overdueDays** | 共通 | 復習期限を超過した日数 | 非表示 |

**strength（忘却曲線）**

| strength | 次回出題間隔 |
|---|---|
| 1 | 1日後 |
| 2 | 3日後 |
| 3 | 7日後 |
| 4 | 14日後 |
| 5 | 30日後 |

**strength 更新ルール（共通）**

| 事象 | 処理 |
|---|---|
| 正解 | strength +1（最大5） |
| 不正解／スキップ | strength = 1 |
| 算数 retired | 裏で strength / nextReview は更新継続 |

### 5.2 段階的解放

**解放条件（次レベルを解放）**
* 判定対象：各科目メインレベルの「復習以外」直近20問
* 閾値：正答率85%以上
* 解放成立：最大解放レベルが+1

**メイン昇格（最大解放 → メイン化）**
* **英語**：最大解放レベル内の単語の70%を1回でも解いたら昇格
* **算数**：最大解放レベルの「復習以外」を30問こなしたら昇格

**不変条件（共通）**
1. 解放 (`unlocked`) されていないレベルは有効 (`enabled`) にできない
2. メインレベルは常に `unlocked=true` かつ `enabled=true`
3. すべてOFFになった場合は、メインレベルを自動でONに戻す

### 5.3 出題ロジック（ブロック生成フロー）

**基本方針**
* **5問 = 1ブロック** として出題
* ロジックは科目ごとに完全に分離する
* **出し過ぎ防止（共通ガード）**: 1ブロック内で同一 wordId / skillId は最大2回まで。

**ブロック決定フロー**

1. **英語の復習チェック**（最優先）
   * 条件：英語の「要復習」単語が存在 AND 直近40問中の復習比率 < 50%
   * 判定：YESなら **「英語復習ブロック」** を生成

2. **通常ブロック生成**
   * 算数か英語かを決定（直近40問のバランスを見て不足している方、差がなければランダム）
   * 決定した科目のロジックで「通常ブロック」を生成

### 5.3.3 復習出題時の補助表示（Visual Feedback）

* 復習スキルや以前間違えた問題が出題される際、**問題表示直後に一瞬だけ** 補助ラベルを表示する。
* **目的**: 「なぜ簡単な問題が出るのか」への納得感を与える。
* **仕様**:
  * 文言: 🔁「まえに やったところ」「もういちど やってみよ」
  * 挙動: 0.5秒フェードなどでさりげなく表示し、消える。
  * 頻度: 毎回ではなく、久しぶりの出題や正答率低下時などに限定してもよい。

### 5.4 科目別ロジック詳細

#### A) 英語ロジック（暗記重視）

**英語 出題ロジック（要点）**

| 項目 | 内容 |
|---|---|
| 管理単位 | wordId |
| 復習 | Due を**復習ブロック**で出題（強制力あり） |
| 優先 | overdueDays が大きいもの |
| 通常配分 | 例：メイン50% / -1 25% / -2 15% / -3 10% |
| 選択肢 | 同レベル優先、同訳除外、誤答クールダウン |

**英語に status がない理由**

| 観点 | 方針 |
|---|---|
| 学習性質 | 記憶・想起（忘却前提） |
| 卒業概念 | 持たない（事故の元） |
| 出題停止 | nextReview による自然低下に任せる |
| 復活 | 間違えたら strength=1 で自動復帰 |

#### B) 算数ロジック（スキル重視）

**算数 status（算数専用）**

| status | 意味 | 出題扱い |
|---|---|---|
| **active** | 現在学習中 | 通常出題 |
| **maintenance** | 忘却防止の維持 | 低頻度出題 |
| **retired** | 十分安定し卒業 | 原則出題しない |

**status と weak の関係**

| status | weak 判定 |
|---|---|
| active | あり |
| maintenance | なし |
| retired | なし |

**status 遷移（想定）**

| from | 条件 | to |
|---|---|---|
| active | 十分安定（30問以上＆直近90%以上） | retired |
| retired | 維持確認時のみ | maintenance |
| maintenance | 失敗が続く（将来拡張） | active |

**算数 出題ロジック（要点）**

| 項目 | 内容 |
|---|---|
| 管理単位 | skillId |
| ブロック | 5問＝1ブロック |
| 復習 | **専用ブロックなし**（通常に混入） |
| 優先順位 | Due → 未調整（未出/低Strength） → レベル配分 |
| レベル配分 | +1レベルは**最大30%（上限）** |
| maintenance | retired から低頻度（例：1%） |

### 5.5 苦手（weak）判定と混入

**weak（苦手）**

| 項目 | 内容 |
|---|---|
| 定義 | 直近成績が不安定な学習対象（内部状態） |
| 目的 | 出題優先度の調整（評価ラベルではない） |
| 判定条件 | 最低5回以上回答 ＋ 直近10回の正答率が低い（<60%） |
| 解除条件 | 直近10回の正答率が回復（>=80%） |
| 混入上限 | 通常ブロックの最大30% |
| UI表示 | しない |

**weak の科目差**

| | 英語 | 算数 |
|---|---|---|
| 管理単位 | wordId | skillId |
| 出題方法 | 復習／通常で優先 | 通常に自然混入 |
| 専用ブロック | あり（復習時） | なし |
| 出題圧 | 強め | 弱め |

---

### 5.6 初期レベル設定ロジック（Start Level Logic）

初回起動時にユーザーに最適なレベルを提供するためのロジック。

#### A) 算数：学年基準＋補正方式

**1. 基準レベル（Base Level）**
* 学年ごとに「基準となる算数レベルID」を内部定義する（補遺C参照）。
* 例：小学2年生 → Lv.X（足し算筆算付近）

**2. 補正（Adjustment）**
* 初回質問「どこまでやった？」の回答により、基準レベルに対し **±Nレベル** の補正を行う。
* 補正値マッピング（例）：
  * 数をかぞえる: -5
  * 足し算まで: -2
  * 引き算まで: 0
  * 筆算: +2
  * かけ算: +5

**3. スタートレベル適用（Impose）**
* 補正後のレベルを `mathStartLevel` とする。
* **解放ロジック**:
  * Level 1 〜 `mathStartLevel` まではすべて `unlocked=true` とする。
  * `mathStartLevel` の1つ上を `mainLevel`（現在の学習対象）とする。
  * `maxUnlockedLevel` も `mainLevel` と同じにする。
* 「簡単すぎて退屈」という離脱要因を防ぐため、既知の範囲はスキップさせる（ただしいつでも戻れる）。

#### C) 安全装置（Safety Net: 内部仕様）

自己申告は過大評価になりやすいため、**初期設定直後の一定期間** は以下の比率で下位レベルを混在させる（UIでの説明は行わない）。

* **混入比率（目安）**
  * `mathStartLevel` : 90%
  * `-1 Level` : 5%
  * `-2 Level` : 5%
* **解除**: 正答率が安定して高い状態が続けば、自然にメインレベルのみに収束させる（通常の苦手判定ロジックに委ねる）。

#### B) 英語：簡易推定

* 英語は算数ほど細かく刻まない。
* 学年（中学生判定など）と「経験有無」のクロスで、初期単語レベル（Lv.1 or Lv.5 or Lv.10程度）を決定する。
* 基本は Lv.1 からの積み上げを推奨するが、経験者のために多少のスキップを許容する。

---

## 6. テスト機能（アプリ内・PDF）

※ 「ちからチェック（アプリ内テスト）」および「PDF印刷」の詳細は **[06_screen_specs.md](06_screen_specs.md)** を参照のこと。

### 6.1 概要

- **ちからチェック**：きろくタブ内で実施。評価・点数は出さない。
- **PDF印刷**：科目単独で生成。成績評価は載せない。
---

## 7. データ構造（ローカル保存）

### 7.1 方針

* **完全ローカル（Local Only）**: 全データは端末内 IndexedDB に保存。
* **アカウント不要**: ログイン機能は持たない。
* **同期なし**: 複数端末間の同期は行わない（将来検討）。

### 7.1.1 初期化（プロフィール作成時）
* 2.4「初回起動時の初期化」に従う。
* `schemaVersion` はアップデート時に段階移行できるように保持する。

### 7.1.3 ログ保存方針（Logging Policy）

* **Problem（個々の問題）**: **永続保存しない**。都度生成し、使い捨てとする。
* **SkillStats（累積統計）**: `UserProfile` 内で永続保持（学習進捗の正体）。
* **AttemptLog（直近履歴）**: **直近300件** をリングバッファで保持。デバッグや直近の振り返りに使用。

### 7.2 データモデル（TypeScript）

```typescript
type SubjectMode = "mix" | "math" | "vocab";
type SubjectKey = "math" | "vocab";
type SkillStatus = "active" | "maintenance" | "retired";

interface AppData {
  schemaVersion: number;
  activeProfileId: string;
  profiles: Record<string, UserProfile>;

}

interface UserProfile {
  profileId: string;
  displayName: string;
  avatarId?: string;
  createdAt: string;
  updatedAt: string;
  syncMeta?: { lastPushedAt?: string; lastPulledAt?: string; dirty: boolean };
  userData: UserData;
}

interface UserData {
  grade: number;

  // 初期設定値（分析・リカバリ用）
  mathStartLevel: number;
  vocabStartLevel: number;

  // レベル状態（科目ごとに分離）
  mainLevelMath: number;
  maxUnlockedLevelMath: number;
  mainLevelVocab: number;
  maxUnlockedLevelVocab: number;
  subjectMode: SubjectMode;
  mathLevels: LevelState[];
  vocabLevels: LevelState[];
  mathSkills: Record<string, MemoryState>;
  vocabWords: Record<string, MemoryState>;
  
  // 直近ログ（リングバッファ N=300）
  recentAttempts: AttemptLog[];
  
  streakDays: number;
  todayCount: number;
  lastStudyDate: string;
  soundEnabled: boolean;
  dailyGoal: number;
}

interface AttemptLog {
  id: string;        // UUID
  timestamp: string; // ISO8601
  subject: SubjectKey;
  skillId: string;   // or wordId
  result: "correct" | "incorrect" | "skipped";
  timeMs?: number;   // 解答にかかった時間（任意）
  
  // 以下は保存しない（v1）
  // seed, operands, userInputs, problemText
}

interface LevelState {
  level: number;
  unlocked: boolean;
  enabled: boolean;

  // 解放判定用：復習以外の回答のみを、メインレベルに対して直近20件リングバッファで保持
  // ※「メインレベルが変わったら、その時点で空にリセット」する（判定の対象が変わるため）
  // ※この配列は「そのレベルがメインである間」だけ意味を持つ
  recentAnswersNonReview: boolean[];

  updatedAt?: string;
}

interface MemoryState {
  strength: number;
  lastCorrect?: string;
  nextReview: string;
  totalAnswers: number;
  correctAnswers: number;
  incorrectAnswers: number;
  skippedAnswers: number;
  updatedAt?: string;
  deletedAt?: string;
  
  // 算数用ステータス（英語は undefined または無視）
  status?: SkillStatus;
}
```

---

## 8. 技術仕様

| 項目 | 選定 |
|---|---|
| フレームワーク | React + TypeScript |
| スタイリング | Tailwind CSS |
| データ保存 | IndexedDB / localStorage |
| 同期 | なし（Local Only） |
| ビルド | Vite |
| ホスティング | Vercel / Netlify |
| PWA | Service Worker |
| スワイプ | react-swipeable |
| サウンド | Howler.js |



## 9. 今後の検討事項

| 項目 | 備考 |
|---|---|
| 音声読み上げ | 英単語の発音確認 |
| 例文表示 | 文脈理解 |
| 単位換算 | 算数追加候補 |
| 時間計算 | 算数追加候補 |
| クラウド同期 | 複数端末利用への対応（V2以降） |

---

## 補遺A：仕様書間の整合ルール

| 起きがち | 原因 | 防止策 |
|---|---|---|
| レベル食い違い | 子に独自記述 | 設計は01のみ |
| 数値二重管理 | 複数箇所に記述 | 数値は01集約 |
| inputType揺れ | 用語不統一 | single/multi/choice |
| 誤答枯渇 | 語数不足 | フォールバックは01 |

## 補遺B：定数・閾値一覧（Single Source of Truth）

| 名称 | 値 | 用途 | 参照 |
|---|---:|---|---|
| 解放判定 窓サイズ | 20問 | メインレベルの復習以外の直近窓 | 5.2 |
| 解放判定 閾値 | 85% | 次レベル解放 | 5.2 |
| 英語メイン昇格 | 70% | 最大解放レベルの単語到達率 | 5.2 |
| 算数メイン昇格 | 30問 | 最大解放レベルの復習以外 | 5.2 |
| 算数卒業(Retired) 判定数 | 30問 | 卒業判定に必要な最小回答数 | 5.4 |
| 算数卒業(Retired) 正答率 | 90% | 卒業判定の正答率閾値 | 5.4 |
| 算数メンテナンス率 | 1% | retiredスキルの出題確率 | 5.4 |
| 復習上限 | 60% | 1セッション内の復習最大比率 | 5.3 |
| セッション窓サイズ | dailyGoal問 | 復習上限などの比率計算の母数（直近N問） | 5.3 |
| 日付境界 | 4:00 | 今日の切替 | 5.1 |
| 期限超過上限 | 7日 | overdueDays 上限 | 5.3 |
| クールダウン | 5問 | 同一項目の連続回避 | 5.3 |
| ブロック内同一ID上限 | 2回 | 1ブロック内での同一ID出題上限 | 5.3 |
| 苦手判定 最低回答数 | 5回 | 苦手判定開始 | 5.5 |
| 苦手判定 閾値(IN) | 60%未満 | 直近10回の正答率がこれ未満ならWeak | 5.5 |
| 苦手判定 閾値(OUT) | 80%以上 | 直近10回の正答率がこれ以上なら解除 | 5.5 |
| 苦手判定 窓 | 直近10回 | 苦手判定の窓 | 5.5 |
| 苦手枠上限 | 30% | 苦手最大比率 | 5.5 |
| 英誤答クールダウン | 直近10問 | 誤答の連続回避 | 5.7 |
| ミックス配分 判定窓 | 20ポイント | 算数:英語の偏り補正（復習除外） | 5.3 |
| ミックス配分 許容幅 | ±20% | 目標比率からの許容幅 | 5.3 |

## 補遺C：学年別基準レベル定義（確定）

**1. 補正マッピング（Adjustment）**

到達目安質問（算数）の回答に対し、以下の値を基準レベルに加算する。

| 選択肢ID | 回答文言 | 補正値 | 想定スキルID (Ref) |
|---|---|---:|---|
| q_count | 数をかぞえる・くらべる | **-5** | count_100 (Lv.3) |
| q_add | 足し算まで | **-3** | add_1d_2 (Lv.5) |
| q_sub | 引き算まで | **-1** | sub_1d1d_c (Lv.6) |
| q_col | 筆算（2けたのたし算・ひき算） | **+1** | add_2d2d_c (Lv.7) |
| q_mul | かけ算（九九） | **+4** | mul_99_rand (Lv.10) |

**2. 学年別基準レベル（Base Level）**

「その学年の標準的な生徒」が「引き算〜筆算手前（Lv.6-7）」あたりにいると仮定した際のベースライン。
基準レベルに補正値を加えたものが `mathStartLevel` となる。

| 学年 | 内部値 | 基準レベル | 理由（回答：筆算+1 の場合） |
|---|---|---:|---|
| 年長 | 0 | **4** | 筆算選択 → Lv.5（足し算基礎）相当から開始 |
| 小1 | 1 | **6** | 筆算選択 → Lv.7（2桁計算）突入 |
| 小2 | 2 | **7** | 筆算選択 → Lv.8（3桁へ） |
| 小3 | 3 | **9** | 筆算選択 → Lv.10（九九後半） |
| 小4 | 4 | **10** | 筆算選択 → Lv.11（掛け算筆算） |
| 小5 | 5 | **11** | 筆算選択 → Lv.12（割り算） |
| 小6 | 6 | **12** | 筆算選択 → Lv.13（余り割り算） ※マルチ回答の練習 |

※ `mathStartLevel = clamp(Base + Adjustment, 1, 20)`
※ 「かけ算(+4)」を選んだ小6は Lv.16（小数）から開始となる。





